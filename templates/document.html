{{template "head" .}}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  * {
    padding: 0;
    margin: 0;
    font-family: Arial;
  }

  .btn-default {
    color: #212121 !important;
    background-color: rgba(154, 154, 154, 0.18);
  }

  .btn {
    background-image: none;
    background-position: 50% 50%;
    background-size: 100% 100%;
    border: 0;
    border-radius: 2px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
    display: inline-block;
    font-size: 14px;
    font-weight: 500;
    line-height: 20px;
    max-width: 100%;
    padding: 8px 8px;
    position: relative;
    text-align: center;
    text-transform: uppercase;
  }

  .card {
    background-color: #ffffff;
    border-radius: 2px;
    box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.06), 0 0 3px rgba(0, 0, 0, 0.18),
      0 1px 3px rgba(0, 0, 0, 0.18);
    display: flex;
    margin-top: 24px;
    margin-bottom: 24px;
    position: relative;
    margin-left: 150px;
    margin-right: 150px;
  }

  .g-2 {
    margin-left: 20px;
  }

  .active-border {
    border-bottom: 3px solid #ff4081 !important;
    border-radius: 5px 5px 0 0 !important;
  }

  #emailModalBody p {
    margin: 4px 0 !important;
    line-height: 1.4;
  }

  #emailModalBody br {
    line-height: 0;
  }

  #emailModalBody img {
    margin: 8px 0;
  }

  .table-bordered {
    margin-top: 20px;
  }

  center {
    margin-left: 20px;
    margin-right: 20px;
  }

  #emailModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
  }

  .closemodal {
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    background-color: #fff;
    color: red;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
{{template "spinner"}}
<div class="card">
  <!-- Email Filter Dropdown -->
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <br /><label for="toFilter" class="floating-label"
        >Select Patient :</label
      >
      <select id="toFilter" style="width: 200px">
        <option value="">Select Patient</option>
        {{range .UniqueRecipients}}
        <option value="{{.}}">{{.}}</option>
        {{end}}
      </select>
      <br /><br />
    </div>
  </div>

  <!-- Email Table -->
  <center>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Doctor
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Summary of Observation
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Date
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Attachments
          </th>
        </tr>
      </thead>
      <tbody id="emailTableBody">
        <tr class="no-records-row">
          <td colspan="4" style="text-align: center; color: gray">
            No Record Found
          </td>
        </tr>
      </tbody>
    </table>
  </center>

  <!-- Email Content Modal -->
  <div id="emailModal">
    <div
      style="
        background: white;
        margin: 5% auto;
        padding: 20px;
        width: 70%;
        border-radius: 12px;
        position: relative;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      "
    >
      <span
        onclick="closeEmailModal()"
        style="
          position: absolute;
          top: 10px;
          right: 15px;
          cursor: pointer;
          font-size: 28px;
          color: #333;
        "
        >&times;</span
      >

      <div id="emailModalBody">‚è≥ Loading...</div>

      <div style="text-align: right; margin-top: 20px">
        <button onclick="closeEmailModal()" class="closemodal">OK</button>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay" onclick="closePopup()"></div>
  <div id="popup" class="popup">
    <div id="popup-content"></div>
  </div>
  <br /><br />
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <a
        href="javascript:void(0);"
        class="btn btn-default"
        onclick="handleBackClick()"
        >BACK</a
      >
    </div>

    <!-- ADD PATIENT Button -->
    <div class="col-auto">
      <a
        href="#"
        class="btn btn-default"
        data-bs-toggle="modal"
        data-bs-target="#addptModal"
        >ADD PATIENT</a
      >

      <!-- Add Patient Modal -->
      <div
        class="modal fade"
        id="addptModal"
        tabindex="-1"
        aria-labelledby="addptModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addptModalLabel">Add Patient</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Mobile Number Input -->

              <input
                type="text"
                id="nameInput"
                class="form-control"
                placeholder="Name"
                style="display: none"
                autocomplete="off"
              />
              <br />

              <input
                type="text"
                id="mobileInput"
                class="form-control"
                placeholder="Enter 10 Digit Mobile"
                maxlength="10"
                onkeypress="checkEnter(event)"
                autocomplete="off"
              />

              <!-- OTP Input (Initially Hidden) -->
              <input
                type="text"
                id="otpInput"
                class="form-control mt-3"
                placeholder="Enter OTP"
                style="display: none"
                maxlength="6"
                autocomplete="off"
              />
              <br />

              <input
                type="email"
                id="emailInput"
                class="form-control"
                style="display: none"
                placeholder="Email"
                autocomplete="off"
              />
              <br />

              <input
                type="date"
                id="dobInput"
                class="form-control"
                style="display: none"
                placeholder="DOB"
                autocomplete="off"
              />
              <br />

              <input
                type="text"
                id="genderInput"
                class="form-control"
                style="display: none"
                placeholder="Gender"
                autocomplete="off"
              />
              <br />

              <label>
                <input
                  type="checkbox"
                  name="checkbox_name"
                  value="checkbox_value"
                  id="chkbox"
                />
                Allow View All Records
              </label>
              <!-- Name Input (Initially Hidden) -->
              <!-- Patient Details Input - shown after OTP success -->
              <!-- Patient Details Input - shown after successful OTP -->
              <!-- <input type="text" id="afterOtpInput" placeholder="Enter Patient Name" class="form-control mt-3" style="display: none;" /> -->

              <input
                type="text"
                id="nameInput"
                placeholder="Enter Name"
                class="form-control mt-3"
                style="display: none"
              />
              <input
                type="tel"
                id="mobileInput"
                placeholder="Mobile Number"
                class="form-control mt-3"
                style="display: none"
              />
              <input
                type="email"
                id="emailInput"
                placeholder="Email"
                class="form-control mt-3"
                style="display: none"
              />
              <input
                type="date"
                id="dobInput"
                placeholder="DOB"
                class="form-control mt-3"
                style="display: none"
              />
              <input
                type="text"
                id="dobInput"
                placeholder="Gender"
                class="form-control mt-3"
                style="display: none"
              />
              <label style="display: none" id="chkbox"
                ><input type="checkbox" class="form-control mt-3"
              /></label>
              <button
                id="savePatientButton"
                type="button"
                class="btn btn-default mt-3"
                style="
                  display: none;
                  background-color: rgba(154, 154, 154, 0.18);
                "
                disabled
              >
                Save Patient
              </button>

              <!-- NEXT / Submit Button -->
              <button
                type="button"
                class="btn btn-secondary mt-3"
                id="nextButton"
                style="
                  width: 100%;
                  margin: 25px auto 3%;
                  box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
                "
                onclick="handleNextClick()"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-auto">
      <a
        href="javascript:void(0);"
        class="btn btn-default"
        data-patient-id="1"
        rev="opd-link"
      >
        OPD
      </a>
      <div
        class="modal fade"
        id="opdMessageModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="opdMessageText"
                style="font-size: 18px; margin: 15px 0"
              ></p>
              <div class="d-flex justify-content-end">
                <button
                  type="button"
                  class="btn"
                  style="
                    all: unset;
                    color: red;
                    cursor: pointer;
                    font-size: 16px;
                  "
                  data-bs-dismiss="modal"
                >
                  OK
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade"
        id="opdModal"
        tabindex="-1"
        aria-labelledby="opdModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="opdModalLabel">OPD</h5>
              <span
                id="patientMobile"
                style="font-size: 1.25rem; color: #212529; margin-left: 10px"
              ></span>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul class="nav nav-tabs" id="opdTabs" role="tablist">
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="notes-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#notes"
                    type="button"
                    style="color: #ff4081"
                  >
                    OPD NOTES
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="prescription-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#prescription"
                    type="button"
                    style="color: #ff4081"
                  >
                    PRESCRIPTION
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="followup-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#followup"
                    type="button"
                    style="color: #ff4081"
                  >
                    FOLLOW-UP DATE
                  </button>
                </li>
              </ul>
              <div class="tab-content" id="opdTabsContent">
                <div class="tab-pane fade show active" id="notes">
                  <textarea
                    class="form-control"
                    placeholder="Add OPD Notes"
                    rows="5"
                  ></textarea>
                </div>
                <div class="tab-pane fade" id="prescription">
                  <textarea
                    class="form-control"
                    placeholder="Add Prescription"
                    rows="5"
                  ></textarea>
                </div>
                <div class="tab-pane fade" id="followup">
                  <div class="mb-3">
                    <label for="followupDate" class="form-label"
                      >Next Followup Date</label
                    >
                    <input
                      type="date"
                      id="followupDate"
                      class="form-control"
                      placeholder="Next Followup Date"
                    />
                    <div class="invalid-feedback">
                      Please select a follow-up date.
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="followupTime" class="form-label"
                      >Next Followup Time</label
                    >
                    <input
                      type="time"
                      id="followupTime"
                      class="form-control"
                      placeholder="Next Followup Time"
                    />
                    <div class="invalid-feedback">
                      Please select a follow-up time.
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goToPreviousTab()"
                style="
                  color: #4caf50;
                  background-color: rgba(154, 154, 154, 0.36);
                "
              >
                PREVIOUS
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goToNextTab()"
                style="
                  color: #4caf50;
                  background-color: rgba(154, 154, 154, 0.36);
                "
              >
                NEXT
              </button>
              <button
                type="submit"
                class="btn btn-danger"
                id="saveBtn"
                style="display: none"
                onclick="saveOPDDetails()"
              >
                SAVE
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- New Warning Modal -->
      <div
        class="modal fade"
        id="warningModal"
        tabindex="-1"
        aria-labelledby="warningModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div
              class="modal-header"
              style="color: #ffffff; background-color: #4caf50"
            >
              <h5 class="modal-title" id="warningModalLabel">Error</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body fw-bold" id="warningMessage">
              <!-- Warning message will be inserted here dynamically -->
            </div>
            <div class="modal-footer">
              <button
                type="submit"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
                style="
                  color: #4caf50;
                  background-color: rgba(154, 154, 154, 0.36);
                "
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-auto">
      <!-- View All Records Button -->
      <!-- View All Records Button -->
      <a href="javascript:void(0);" id="viewRecordsBtn" class="btn btn-default">
        VIEW ALL RECORDS
      </a>

      <!-- Main All Record Modal -->
      <div
        class="modal fade"
        id="allrecordModal"
        tabindex="-1"
        aria-labelledby="allrecordModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                Allow access to all records permanently
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Readonly Mobile Number -->
              <input
                type="text"
                id="phoneInput"
                class="form-control"
                placeholder="Enter 10 Digit Mobile"
                maxlength="10"
                readonly
              />

              <!-- OTP Field -->
              <input
                type="text"
                id="OTPInput"
                class="form-control mt-3"
                placeholder="Enter OTP"
                maxlength="6"
                style="display: none"
              />

              <!-- Button -->
              <button
                type="button"
                class="btn btn-secondary mt-4"
                id="nextBtn"
                style="width: 100%; box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3)"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- OTP Success Modal -->
      <div class="modal fade" id="otpSuccessModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="otpSuccessText"
                class="text-success"
                style="font-size: 18px"
              ></p>
              <button
                type="button"
                class="btn"
                style="
                  all: unset;
                  color: green;
                  cursor: pointer;
                  font-size: 16px;
                "
                data-bs-dismiss="modal"
                onclick="closeAllRecordModal()"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- OTP Error Modal -->
      <div class="modal fade" id="otpErrorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="otpErrorText"
                class="text-danger"
                style="font-size: 18px"
              ></p>
              <button
                type="button"
                class="btn"
                style="all: unset; color: red; cursor: pointer; font-size: 16px"
                data-bs-dismiss="modal"
                onclick="keepOtpVisibleAfterError()"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Modal for OPD -->
      <div class="modal fade" id="opdMessageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p id="opdMessageText" style="font-size: 18px"></p>
              <button
                type="button"
                class="btn"
                style="
                  all: unset;
                  color: #007bff;
                  cursor: pointer;
                  font-size: 16px;
                "
                data-bs-dismiss="modal"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br /><br /><br />
</div>
<script>
  // ‚úÖ Handles "Next" click in Add Patient modal
  function handleNextClick() {
    const mobileInput = document.getElementById("mobileInput");
    const otpInput = document.getElementById("otpInput");
    const nextButton = document.getElementById("nextButton");

    const mobileNumber = mobileInput.value.trim();

    if (!/^\d{10}$/.test(mobileNumber)) {
      alert("‚ùå Please enter a valid 10-digit mobile number");
      return;
    }

    // Generate OTP
    fetch("/generate-otp-card", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ mobile: mobileNumber }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          otpInput.style.display = "block";
          mobileInput.setAttribute("readonly", true);
          nextButton.textContent = "Submit";
          nextButton.onclick = submitAddPatientOtp;
        } else {
          alert("‚ùå Failed to generate OTP");
        }
      })
      .catch((err) => {
        console.error("OTP generation failed:", err);
        alert("‚ö†Ô∏è Could not generate OTP. Try again.");
      });
  }

  function submitOtpAddPatient(event) {
    if (event) event.preventDefault(); // ‚úÖ Prevent form submission / page reload

    const mobile = document.getElementById("mobileInput").value.trim();
    const otp = document.getElementById("otpInput").value.trim();

    if (!otp) {
      const otpErrorModal = new bootstrap.Modal(
        document.getElementById("otpErrorModal")
      );
      document.getElementById("otpErrorText").textContent =
        "‚ùå Please enter the OTP.";
      otpErrorModal.show();
      return;
    }

    fetch("/verify-otp-card", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ mobile, otp }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("OTP Verify Response:", data);

        if (data.success) {
          // ‚úÖ Show success modal
          const successModal = new bootstrap.Modal(
            document.getElementById("otpSuccessModal")
          );
          document.getElementById("otpSuccessText").textContent =
            "‚úÖ OTP verified successfully!";
          //successModal.show();

          // ‚úÖ Show new input & Save button (disabled)
          document.getElementById("otpInput").style.display = "none";
          document.getElementById("nextButton").style.display = "none";

          /*document.getElementById("afterOtpInput").style.display = "block";
        document.getElementById("emailInput").style.display = "block";
        document.getElementById("dobInput").style.display = "block";
        document.getElementById("genderInput").style.display = "block";
        document.getElementById("chkbox").style.display = "block";*/

          const saveBtn = document.getElementById("savePatientButton");
          saveBtn.style.display = "block";
          saveBtn.disabled = true; // üëà keep it disabled for now
        } else {
          // ‚ùå Invalid OTP
          const errorModal = new bootstrap.Modal(
            document.getElementById("otpErrorModal")
          );
          document.getElementById("otpErrorText").textContent =
            "‚ùå " + (data.error || "Invalid OTP.");
          errorModal.show();
        }
      })
      .catch((err) => {
        console.error("OTP Verification Error:", err);
        const errorModal = new bootstrap.Modal(
          document.getElementById("otpErrorModal")
        );
        document.getElementById("otpErrorText").textContent =
          "‚ö†Ô∏è Something went wrong. Try again.";
        errorModal.show();
      });
  }

  // ‚úÖ Optional: Clear fields when modal closes
  document
    .getElementById("addptModal")
    .addEventListener("hidden.bs.modal", () => {
      document.getElementById("mobileInput").value = "";
      document.getElementById("otpInput").value = "";
      document.getElementById("otpInput").style.display = "none";
      document.getElementById("afterOtpTextbox").style.display = "none";
      const nextBtn = document.getElementById("nextButton");
      nextBtn.textContent = "Next";
      nextBtn.style.display = "block";
      nextBtn.onclick = handleNextClick;
      document.getElementById("mobileInput").removeAttribute("readonly");
    });

  // ‚úÖ Handles "Next" click in Add Patient modal
  function handleNextClick() {
    const mobileInput = document.getElementById("mobileInput");
    const otpInput = document.getElementById("otpInput");
    const nextButton = document.getElementById("nextButton");

    const mobileNumber = mobileInput.value.trim();

    if (!/^\d{10}$/.test(mobileNumber)) {
      alert("‚ùå Please enter a valid 10-digit mobile number");
      return;
    }

    // Generate OTP
    fetch("/generate-otp-card", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ mobile: mobileNumber }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          otpInput.style.display = "block";
          mobileInput.setAttribute("readonly", true);
          nextButton.textContent = "Submit";
          nextButton.onclick = submitOtpAddPatient; // ‚úÖ Corrected function name
        } else {
          alert("‚ùå Failed to generate OTP");
        }
      })
      .catch((err) => {
        console.error("OTP generation failed:", err);
        alert("‚ö†Ô∏è Could not generate OTP. Try again.");
      });
  }

  // ‚úÖ Handles OTP submission and confirmation
  function submitOtpAddPatient() {
    const mobile = document.getElementById("mobileInput").value.trim();
    const otp = document.getElementById("otpInput").value.trim();

    if (!otp) {
      const otpErrorModal = new bootstrap.Modal(
        document.getElementById("otpErrorModal")
      );
      document.getElementById("otpErrorText").textContent =
        "‚ùå Please enter the OTP.";
      otpErrorModal.show();
      return;
    }

    fetch("/verify-otp-card", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ mobile, otp }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("OTP Verify Response:", data);

        if (data.success) {
          // ‚úÖ Show OTP success modal (without closing add patient modal)
          const successModal = new bootstrap.Modal(
            document.getElementById("otpSuccessModal")
          );
          document.getElementById("otpSuccessText").textContent =
            "‚úÖ OTP verified successfully!";
          //successModal.show();

          // ‚úÖ Hide OTP input and Next button
          document.getElementById("otpInput").style.display = "none";
          document.getElementById("nextButton").style.display = "none";
          /*document.getElementById("emailInput").style.display = "none";
        document.getElementById("dobInput").style.display = "none";
        document.getElementById("genderInput").style.display = "none";
        document.getElementById("chkbox").style.display = "none";*/

          // ‚úÖ Show input boxes
          document.getElementById("nameInput").style.display = "block";
          document.getElementById("emailInput").style.display = "block";
          document.getElementById("dobInput").style.display = "block";
          document.getElementById("genderInput").style.display = "block";
          document.getElementById("chkbox").style.display = "block";

          // ‚úÖ Optionally show a save button
          const saveBtn = document.getElementById("savePatientButton");
          if (saveBtn) {
            saveBtn.style.display = "block";
          }
        } else {
          const errorModal = new bootstrap.Modal(
            document.getElementById("otpErrorModal")
          );
          document.getElementById("otpErrorText").textContent =
            "‚ùå " + (data.error || "Invalid OTP.");
          errorModal.show();
        }
      })
      .catch((err) => {
        console.error("OTP Verification Error:", err);
        const errorModal = new bootstrap.Modal(
          document.getElementById("otpErrorModal")
        );
        document.getElementById("otpErrorText").textContent =
          "‚ö†Ô∏è Something went wrong. Try again.";
        errorModal.show();
      });
  }

  // ‚úÖ Clear fields when modal is closed
  document
    .getElementById("addptModal")
    .addEventListener("hidden.bs.modal", () => {
      const mobileInput = document.getElementById("mobileInput");
      const otpInput = document.getElementById("otpInput");
      /*const afterOtpInput = document.getElementById("afterOtpInput");*/
      const nextBtn = document.getElementById("nextButton");

      mobileInput.value = "";
      otpInput.value = "";
      otpInput.style.display = "none";
      mobileInput.removeAttribute("readonly");

      /*if (afterOtpInput) afterOtpInput.style.display = "none";*/

      nextBtn.textContent = "Next";
      nextBtn.style.display = "block";
      nextBtn.onclick = handleNextClick;
    });

  // Open Modal and set mobile
  document
    .getElementById("viewRecordsBtn")
    .addEventListener("click", function () {
      const dropdown = document.getElementById("toFilter");
      const selectedPatient = dropdown.value;

      if (!selectedPatient) {
        document.getElementById("opdMessageText").textContent =
          "Please Select Patient to proceed further.";
        new bootstrap.Modal(document.getElementById("opdMessageModal")).show();
      } else {
        const mobile = selectedPatient.split("@")[0];
        document.getElementById("phoneInput").value = mobile;

        new bootstrap.Modal(document.getElementById("allrecordModal")).show();
      }
    });

  // When modal opens - reset it
  document
    .getElementById("allrecordModal")
    .addEventListener("show.bs.modal", function () {
      const dropdown = document.getElementById("toFilter");
      const selectedValue = dropdown.value;

      const mobileOnly = selectedValue.split("@")[0];
      const mobileInput = document.getElementById("phoneInput");

      mobileInput.value = mobileOnly;
      mobileInput.setAttribute("readonly", true);

      // Reset OTP input
      const otpInput = document.getElementById("OTPInput");
      otpInput.style.display = "none";
      otpInput.value = "";

      const nextBtn = document.getElementById("nextBtn");
      nextBtn.textContent = "Next";
      nextBtn.onclick = showOtpInput;
    });

  // Show OTP Field & call backend
  function showOtpInput() {
    const mobileInput = document.getElementById("phoneInput");
    const otpInput = document.getElementById("OTPInput");
    const nextBtn = document.getElementById("nextBtn");

    const mobileNumber = mobileInput.value.trim();
    if (!/^\d{10}$/.test(mobileNumber)) {
      alert("Please enter a valid 10-digit mobile number");
      return;
    }

    fetch("/generate-otp-card", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ mobile: mobileNumber }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          otpInput.style.display = "block";
          mobileInput.setAttribute("readonly", true);
          nextBtn.textContent = "Submit";
          nextBtn.onclick = submitOtp;
        } else {
          alert("‚ùå Failed to generate OTP");
        }
      })
      .catch((err) => {
        console.error("OTP generation failed:", err);
        alert("‚ö†Ô∏è Could not generate OTP. Try again.");
      });
  }

  // Submit OTP
  function submitOtp() {
    const otp = document.getElementById("OTPInput").value.trim();
    const mobile = document.getElementById("phoneInput").value.trim();

    if (!otp) {
      const errorModal = new bootstrap.Modal(
        document.getElementById("otpErrorModal")
      );
      document.getElementById("otpErrorText").textContent =
        "Please enter the OTP";
      errorModal.show();
      return;
    }

    fetch("/verify-otp-card", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ mobile, otp }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          const successModal = new bootstrap.Modal(
            document.getElementById("otpSuccessModal")
          );
          document.getElementById("otpSuccessText").textContent =
            "‚úÖ OTP verified successfully!";
          successModal.show();
        } else {
          const errorModal = new bootstrap.Modal(
            document.getElementById("otpErrorModal")
          );
          document.getElementById("otpErrorText").textContent =
            "‚ùå " + (data.error || "Invalid OTP");
          errorModal.show();
        }
      })
      .catch((err) => {
        const errorModal = new bootstrap.Modal(
          document.getElementById("otpErrorModal")
        );
        document.getElementById("otpErrorText").textContent =
          "‚ö†Ô∏è Something went wrong. Try again.";
        errorModal.show();
      });
  }

  // Keep OTP field visible after error
  function keepOtpVisibleAfterError() {
    const otpInput = document.getElementById("OTPInput");
    otpInput.style.display = "block";
    otpInput.value = ""; // Clear the input value
  }

  // Close allrecordModal after success
  function closeAllRecordModal() {
    const modal = bootstrap.Modal.getInstance(
      document.getElementById("allrecordModal")
    );
    if (modal) modal.hide();
    location.reload();
  }

  function handleBackClick() {
    fetch("/dashboard", {
      method: "GET",
      headers: { "X-Requested-With": "XMLHttpRequest" },
    })
      .then((response) => {
        if (response.redirected || response.status === 401) {
          setTimeout(() => {
            alert("Session expired. Redirecting to login.");
            window.location.href = "/login";
          }, 0);
          throw new Error("Session expired");
        }

        // If session is still valid, navigate
        window.location.href = "/dashboard";
      })
      .catch((err) => {
        console.error("‚ùå BACK navigation error:", err);
      });
  }

  var loggedInEmail = "{{.Email}}";
  console.log("üë§ Logged-in email:", loggedInEmail);
  // If session expired (Email not present), block all interaction and redirect
  if (!loggedInEmail || loggedInEmail.trim() === "") {
    console.warn(
      "üö® Session expired. Blocking interaction and redirecting to login..."
    );

    // Prevent all clicks on buttons, links, etc.
    document.addEventListener(
      "click",
      function (e) {
        const target = e.target.closest("a, button");
        if (!target) return;

        // Ping your existing EmailHandler route (AJAX)
        fetch(window.location.pathname, {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest", // triggers AJAX branch in your handler
          },
        })
          .then((response) => {
            if (response.redirected) {
              console.warn(
                "üîí Session expired (redirected response). Redirecting to /login"
              );
              e.preventDefault();
              window.location.href = "/login";
            } else {
              // Optional: still check if response contains error JSON
              return response
                .json()
                .then((data) => {
                  if (data?.error === "Recipient email is required") {
                    console.warn(
                      "üîí AJAX session invalid (bad request). Redirecting."
                    );
                    e.preventDefault();
                    window.location.href = "/login";
                  }
                })
                .catch(() => {
                  /* not JSON? do nothing */
                });
            }
          })
          .catch((err) => {
            console.error("‚ùå Error checking session:", err);
            e.preventDefault();
            window.location.href = "/login";
          });
      },
      true
    );
    // Optional UI message
    alert("Session expired. Redirecting to login...");

    // Redirect to login
    window.location.href = "/login";
  }

  document.addEventListener("DOMContentLoaded", function () {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("followupDate").setAttribute("min", today);
  });
  // PDF Generation call on button click
  // Function to call PDF generation
  function generatePDF() {
    const dropdown = document.getElementById("toFilter");
    const selectedValue = dropdown.value;

    if (!selectedValue) {
      alert("Please select a patient.");
      return;
    }

    // Extract only the mobile number part
    const mobileNumber = selectedValue.split("@")[0];

    fetch("/generate-pdf", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ patientEmail: mobileNumber }), // send only mobile number
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.message) {
          alert("‚úÖ " + data.message);
        } else {
          alert("‚ùå Error: " + data.error);
        }
      })
      .catch((error) => {
        console.error("PDF generation failed:", error);
        alert("‚ùå PDF generation request failed.");
      });
  }

  // Show a loading message while fetching

  // Show an error message

  function logout() {
    fetch("/logout", { method: "GET" })
      .then((response) => {
        if (response.redirected) {
          window.location.href = response.url; // Redirect to login page
        }
      })
      .catch((error) => console.error("Logout failed:", error));
  }

  document.addEventListener("DOMContentLoaded", function () {
    const dropdown = document.getElementById("toFilter");
    const modalTitle = document.getElementById("opdModalLabel");

    // Fetch email recipients
    fetch("/get-recipients")
      .then((response) => {
        if (!response.ok) {
          // If the response has a status code indicating an error, throw an error
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        // Initialize the dropdown with a default option
        dropdown.innerHTML = '<option value="">Select Patient</option>';

        // Use a Set to store unique email addresses
        const uniqueEmails = new Set();

        data.forEach((email) => {
          // Check if the email is valid and contains the '@' symbol
          if (email && email.includes("@")) {
            // Trim any leading or trailing whitespace from the email
            const fullEmail = email.trim();

            // Add the email to the Set if it's not already present
            if (!uniqueEmails.has(fullEmail)) {
              uniqueEmails.add(fullEmail);

              // Create a new option element for the dropdown
              const option = document.createElement("option");
              option.value = fullEmail; // Set the option's value to the full email
              option.textContent = fullEmail; // Display the full email in the dropdown

              // Append the option to the dropdown
              dropdown.appendChild(option);
            }
          }
        });
      })
      .catch((error) => {
        console.error("Error fetching recipients:", error);
      });

    // ‚úÖ OPD button click handler
    document.querySelectorAll('a[rev="opd-link"]').forEach(function (opdBtn) {
      opdBtn.addEventListener("click", function () {
        const selectedPatient = dropdown.value;
        if (!selectedPatient) {
          // Set modal message text
          document.getElementById("opdMessageText").textContent =
            "Please Select Patient to proceed further.";

          // Show message modal
          const messageModal = new bootstrap.Modal(
            document.getElementById("opdMessageModal")
          );
          messageModal.show();
          return;
        }

        // Open OPD modal if patient selected
        const opdModal = new bootstrap.Modal(
          document.getElementById("opdModal")
        );
        opdModal.show();
      });
    });
  });

  document.getElementById("toFilter").addEventListener("change", function () {
    const selectedEmail = this.value;
    if (selectedEmail) {
      filterEmails();
    } else {
      document.getElementById("emailTableBody").innerHTML =
        '<tr><td colspan="4"><center>No Record Found</center></td></tr>';
    }
  });

  function filterEmails() {
    const selectedTo = document.getElementById("toFilter").value;
    const tableBody = document.getElementById("emailTableBody");

    if (!selectedTo) {
      tableBody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center; color: gray;">No Record Found</td>
      </tr>`;
      return;
    }

    showSpinner();

    const params = new URLSearchParams({ to: selectedTo });

    fetch(`/emails?${params.toString()}`, {
      headers: { "X-Requested-With": "XMLHttpRequest" },
    })
      .then((response) => {
        if (response.redirected) {
          alert("Session expired. Redirecting to login.");
          window.location.href = "/login";
          return Promise.reject("Redirected due to expired session.");
        }

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        return response.json();
      })
      .then((data) => {
        console.log("‚úÖ API Response:", data);

        const emails = data.emails || [];
        const filteredEmails = emails.filter(
          (email) => email.from === loggedInEmail
        );

        let html = "";

        if (!emails.length || !filteredEmails.length) {
          html = `<tr class="no-records-row">
                  <td colspan="4">No records to display.</td>
                </tr>`;
        } else {
          html = filteredEmails
            .map((email) => {
              const fromName = email.from_name || "Unknown";
              const subject = email.subject || "(No Subject)";
              const date = email.date || "No Date";
              const attachments =
                (email.attachment_names || [])
                  .map(
                    (name) =>
                      `<a href="javascript:void(0);" onclick="renderAttachments(${email.uid}, '${name}')"
                style="color: red; text-decoration: none;">${name}</a>`
                  )
                  .join(", ") || "No Attachments";

              return `
            <tr>
              <td>${fromName}</td>
              <td>
                <a href="javascript:void(0);" onclick="fetchAndShowEmailBody('${email.uid}')"
                   style="color: red; text-decoration: none;">${subject}</a>
              </td>
              <td>${date}</td>
              <td>${attachments}</td>
            </tr>`;
            })
            .join("");
        }

        tableBody.innerHTML = html;
        hideSpinner();
      })
      .catch((err) => {
        console.error("‚ùå Fetch error:", err);
        if (err === "Redirected due to expired session.") return;

        tableBody.innerHTML = `
        <tr>
          <td colspan="4" style="color: red; text-align: center;">
            Error loading emails.
          </td>
        </tr>`;
        hideSpinner();
      });
  }

  function fetchAndShowEmailBody(uid) {
    // Show the global spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    fetch(`/get-email-body?uid=${uid}`)
      .then((response) => {
        // ‚úÖ Session expired: Redirected to /login
        if (response.redirected) {
          alert("Session expired. Redirecting to login.");
          window.location.href = "/login";
          return Promise.reject("Redirected due to expired session.");
        }

        return response.json();
      })
      .then((data) => {
        // Hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");

        // Handle any errors from the server
        if (data.error) {
          alert(data.error);
          return;
        }

        // Format body content
        let bodyContent = data.plainTextBody
          ? data.plainTextBody
              .replace(/\r\n/g, "<br>")
              .replace(/\n/g, "<br>")
              .replace(/(<br\s*\/?>\s*){2,}/g, "<br>")
              .trim()
          : "<p>No content available</p>";

        // Format image attachments
        let attachmentsHtml = "";
        if (data.attachments && data.attachments.length > 0) {
          attachmentsHtml = data.attachments
            .map((att) =>
              att.type === "image"
                ? `<img src="${att.base64}" alt="${att.name}" style="max-width: 300px; margin: 10px 0;"><br>`
                : ""
            )
            .join("");
        }

        // Inject email body + attachments
        document.getElementById("emailModalBody").innerHTML =
          bodyContent + attachmentsHtml;

        // Show modal
        document.getElementById("emailModal").style.display = "block";
      })
      .catch((err) => {
        // Only log errors if not redirected
        if (err !== "Redirected due to expired session.") {
          console.error("Error fetching email body:", err);
          document.getElementById(
            "emailModalBody"
          ).innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
          document.getElementById("spinner-overlay").classList.add("hidden");
        }
      });
  }

  function closeEmailModal() {
    document.getElementById("emailModal").style.display = "none";
  }
  function renderAttachments(uid, attachmentName) {
    if (!uid || !attachmentName) {
      alert("Invalid email ID or attachment name.");
      return;
    }

    const url = `/get-attachment?uid=${encodeURIComponent(
      uid
    )}&attachmentName=${encodeURIComponent(attachmentName)}`;
    const newTab = window.open("", "_blank");

    if (!newTab) {
      alert("Popup blocked! Please allow popups for this website.");
      return;
    }

    // Show global spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    fetch(url)
      .then((response) => {
        // ‚úÖ Check if session expired and user was redirected
        if (response.redirected) {
          newTab.close();
          setTimeout(() => {
            alert("Session expired. Redirecting to login.");
            window.location.href = "/login";
          }, 0);
          throw new Error("Session expired - redirected");
        }
        if (!response.ok) {
          if (response.status === 401) throw new Error("Session expired");
          if (response.status === 404) throw new Error("Attachment not found");
          throw new Error(`Error: ${response.status} ${response.statusText}`);
        }
        return response.blob();
      })
      .then((blob) => {
        const fileUrl = URL.createObjectURL(blob);
        const fileType = blob.type;

        newTab.document.open();
        newTab.document.title = attachmentName;

        if (fileType.startsWith("image/")) {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><h3>${attachmentName}</h3>
          <img src="${fileUrl}" style="max-width: 100%; height: auto;" />
          </body></html>`);
        } else if (fileType === "application/pdf") {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><iframe src="${fileUrl}" width="100%" height="100%" style="border:none; height: 95vh;"></iframe>
          </body></html>`);
        } else {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><h3>Download attachment:</h3>
          <a href="${fileUrl}" download="${attachmentName}">${attachmentName}</a>
          </body></html>`);
        }
        newTab.document.close();
      })
      .catch((err) => {
        console.error("‚ùå Error fetching attachment:", err);
        if (newTab && !newTab.closed) {
          newTab.document.body.innerHTML = `<h3>Failed to load attachment.</h3><p>${
            err.message || err
          }</p>`;
        }
      })
      .finally(() => {
        // ‚úÖ Always hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");
      });
  }

  function downloadAttachment(uid, attachmentName) {
    // Validate parameters
    if (!uid || uid === "0") {
      alert("Invalid email ID");
      return;
    }

    // Construct the URL
    const url = `/get-attachment?uid=${encodeURIComponent(
      uid
    )}&attachmentName=${encodeURIComponent(attachmentName)}`;

    // Show spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    // Pre-validate that the file exists before opening
    fetch(url, { method: "HEAD" }) // Using HEAD just to check if the file exists
      .then((response) => {
        if (!response.ok) {
          if (response.status === 401) throw new Error("Session expired");
          if (response.status === 404) throw new Error("Attachment not found");
          throw new Error("Unable to download the file.");
        }

        // File is valid ‚Äî open in new tab
        window.open(url, "_blank");
      })
      .catch((err) => {
        if (err.message === "Session expired") {
          alert("Your session has expired. Please log in again.");
          window.location.href = "/login";
        } else {
          alert(err.message);
        }
      })
      .finally(() => {
        // Always hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");
      });
  }

  function openEmailModal(element) {
    var emailBody = element.getAttribute("data-body") || "(No body available)";
    var attachmentsData = element.getAttribute("data-attachments");
    var modalBody = document.getElementById("modalBodyContent");

    modalBody.innerHTML = "<p>" + emailBody.replace(/\n/g, "<br>") + "</p>"; // Ensure line breaks display properly

    let attachmentHTML = ""; // ‚úÖ Initialize the variable

    if (attachmentsData && attachmentsData.trim() !== "") {
      let attachmentsArray = attachmentsData
        .split(";")
        .filter((item) => item.trim() !== "");

      attachmentsArray.forEach((item) => {
        let parts = item.split("|");
        if (parts.length < 2) return;

        let filename = parts[0].trim();
        let mimeType = parts[1].trim();
        let filePath = "attachments/" + encodeURIComponent(filename);

        attachmentHTML += `
              <div style="margin-bottom: 10px;">
                  <span style="font-weight: bold;">‚¨á 
                      <a href="${filePath}" target="_blank" style="text-decoration: none; color: blue;">${filename}</a>
                  </span><br>`;

        if (mimeType.startsWith("image/")) {
          attachmentHTML += `<a href="${filePath}" target="_blank">
                  <img src="${filePath}" alt="${filename}" 
                      style="max-width: 100%; height: auto; display: block; margin-top: 5px; 
                      border: 1px solid #ccc; padding: 5px;">
              </a>`;
        }
        attachmentHTML += `</div>`; // Close div for spacing
      });
    }

    modalBody.innerHTML += attachmentHTML; // ‚úÖ Append attachments if available

    var modal = new bootstrap.Modal(document.getElementById("emailModal"));
    modal.show();
  } // Function to decode HTML entities
  function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
  }
  function hasAccessToAllRecords(toEmail, fromEmail, callback) {
    console.log(fromEmail);
    $.get(
      `/api/check-email?from=${fromEmail}&to=${toEmail}`,
      function (response) {
        var statusDiv = document.getElementById("email-status");
        if (response.message.includes("exists")) {
          statusDiv.innerText = "‚úÖ Email exists in the database";
          statusDiv.classList.add("exists");
          statusDiv.classList.remove("not-found");
          callback(true);
        } else {
          statusDiv.innerText = "‚ö†Ô∏è Email not found in database";
          statusDiv.classList.add("not-found");
          statusDiv.classList.remove("exists");
          callback(false);
        }
      }
    ).fail(function () {
      console.error("Error calling API");
      document.getElementById("email-status").innerText =
        "‚ùå Error checking database";
      callback(false);
    });
  }

  function showPopup(body) {
    document.getElementById("modalBodyContent").innerHTML = body;
    var emailModal = new bootstrap.Modal(document.getElementById("emailModal"));
    emailModal.show();
  }
  function closePopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("overlay").style.display = "none";
  }
  let fromName = "{{.FromName}}"; // Injected from controller
  function saveOPDDetails() {
    let mobileNumber = document.getElementById("toFilter").value;
    let opdNotes = document.querySelector("#notes textarea").value.trim();
    let prescription = document
      .querySelector("#prescription textarea")
      .value.trim();
    let followupDateEl = document.getElementById("followupDate");
    let followupTimeEl = document.getElementById("followupTime");
    let followupDate = followupDateEl.value.trim();
    let followupTime = followupTimeEl.value.trim();

    let currentDateTime = new Date()
      .toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
      })
      .replace(",", "");

    // Reset validation styles
    followupDateEl.classList.remove("is-invalid");
    followupTimeEl.classList.remove("is-invalid");

    // Validate required fields
    let isValid = true;
    if (!followupDate) {
      followupDateEl.classList.add("is-invalid");
      isValid = false;
    }
    if (!followupTime) {
      followupTimeEl.classList.add("is-invalid");
      isValid = false;
    }

    // üî¥ IMPORTANT: Stop if validation fails ‚Äî do not send request!
    if (!isValid) {
      alert(
        "‚ö†Ô∏è Please fill Follow-up Date and Follow-up Time before generating PDF."
      );
      return;
    }

    // Proceed with fetch if all fields are valid
    fetch("/generate-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: mobileNumber.split("@")[0],
        opdNotes: opdNotes,
        prescription: prescription,
        followupDate: followupDate,
        followupTime: followupTime,
        doctorName: fromName,
        generatedDateTime: currentDateTime,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          console.log("PDF not generated:", data.error);
          alert("‚ùå Error: " + data.error);
          return;
        }

        if (data.message) {
          alert("‚úÖ PDF generated and sent to Patient email");

          // ‚úÖ Call filterEmails() only after a successful PDF generation
          filterEmails();

          let opdModal = document.getElementById("opdModal");
          let modalInstance = bootstrap.Modal.getInstance(opdModal);
          if (modalInstance) {
            modalInstance.hide();
          } else {
            let newModalInstance = new bootstrap.Modal(opdModal);
            newModalInstance.hide();
          }
        } else {
          alert("‚ùå Error: " + data.error);
        }
      })
      .catch((error) => console.error("‚ùå Error generating PDF:", error));
  }

  function updateTable(entry) {
    let table = document.querySelector("table tbody");
    let row = document.createElement("tr");

    row.innerHTML = `
                    <td>${entry.doctor}</td>
                    <td><a href="#" onclick="showPopup('${
                      entry.opdNotes
                    }')" style="color: red; text-decoration: none;">${entry.opdNotes.substring(
      0,
      30
    )}...</a></td>
                    <td>${entry.followupDate}</td>
                    <td>No attachments</td>
                `;

    table.appendChild(row);
  }

  /*Shuffling of Tabs*/
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll("#opdTabs button");
    const tabContents = document.querySelectorAll(".tab-pane");
    const saveBtn = document.getElementById("saveBtn");
    const nextBtn = document.querySelector(
      ".modal-footer button[onclick='goToNextTab()']"
    );
    const prevBtn = document.querySelector(
      ".modal-footer button[onclick='goToPreviousTab()']"
    );

    // Disable manual clicking on tabs
    tabs.forEach((tab) => {
      tab.setAttribute("disabled", "true");
    });

    function updateButtons() {
      let tabs = document.querySelectorAll("#opdTabs button");
      let activeTab = document.querySelector(".tab-pane.show.active");

      // Remove active-border class from all buttons
      tabs.forEach((tab) => {
        tab.classList.remove("active-border");
      });

      // Highlight the active tab button
      let activeTabButton = document.querySelector(
        `#opdTabs button[data-bs-target="#${activeTab.id}"]`
      );
      if (activeTabButton) {
        activeTabButton.classList.add("active-border");
      }

      // Find index of active tab
      let tabPanes = document.querySelectorAll(".tab-pane");
      let activeIndex = Array.from(tabPanes).findIndex((tab) =>
        tab.classList.contains("show")
      );

      // Show/hide buttons correctly
      prevBtn.style.display = activeIndex === 0 ? "none" : "inline-block";
      nextBtn.style.display =
        activeIndex === tabPanes.length - 1 ? "none" : "inline-block";
      saveBtn.style.display =
        activeIndex === tabPanes.length - 1 ? "inline-block" : "none"; // Fix SAVE button issue
    }

    function showWarningModal(message) {
      document.getElementById("warningMessage").innerHTML = " " + message;
      new bootstrap.Modal(document.getElementById("warningModal")).show();
    }

    function validateCurrentTab() {
      let activeTab = document.querySelector(".tab-pane.show.active");
      let isValid = true;

      if (activeTab.id === "notes") {
        let opdNotes = document.querySelector("#notes textarea").value.trim();
        if (opdNotes === "") {
          showWarningModal("OPD Notes cannot be empty.");
          isValid = false;
        }
      } else if (activeTab.id === "prescription") {
        let prescription = document
          .querySelector("#prescription textarea")
          .value.trim();
        if (prescription === "") {
          showWarningModal("Prescription cannot be empty.");
          isValid = false;
        }
      } else if (activeTab.id === "followup") {
        let followupDate = document.querySelector(
          "#followup input[type='date']"
        ).value;
        let followupTime = document.querySelector(
          "#followup input[type='time']"
        ).value;
        if (followupDate === "" || followupTime === "") {
          showWarningModal("Please select both Follow-up Date and Time.");
          isValid = false;
        }
      }
      return isValid;
    }

    window.goToNextTab = function () {
      if (!validateCurrentTab()) return;

      let activeIndex = Array.from(tabContents).findIndex((tab) =>
        tab.classList.contains("show", "active")
      );
      if (activeIndex < tabContents.length - 1) {
        tabContents[activeIndex].classList.remove("show", "active");
        tabContents[activeIndex + 1].classList.add("show", "active");
      }
      updateButtons();
    };

    window.goToPreviousTab = function () {
      let activeIndex = Array.from(tabContents).findIndex((tab) =>
        tab.classList.contains("show", "active")
      );
      if (activeIndex > 0) {
        tabContents[activeIndex].classList.remove("show", "active");
        tabContents[activeIndex - 1].classList.add("show", "active");
      }
      updateButtons();
    };

    updateButtons();
  });
  function showSpinner() {
    document.getElementById("spinner-overlay").classList.remove("hidden");
  }

  function hideSpinner() {
    document.getElementById("spinner-overlay").classList.add("hidden");
  }
</script>
<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
  integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
  crossorigin="anonymous"
></script>
{{template "footer" .}}
