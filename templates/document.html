{{template "head" .}}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  * {
    padding: 0;
    margin: 0;
    font-family: Arial;
  }

  .btn-default {
    color: #212121 !important;
    background-color: rgba(154, 154, 154, 0.18);
  }

  .btn {
    background-image: none;
    background-position: 50% 50%;
    background-size: 100% 100%;
    border: 0;
    border-radius: 2px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
    display: inline-block;
    font-size: 14px;
    font-weight: 500;
    line-height: 20px;
    max-width: 100%;
    padding: 8px 8px;
    position: relative;
    text-align: center;
    text-transform: uppercase;
  }

  .card {
    background-color: #ffffff;
    border-radius: 2px;
    box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.06), 0 0 3px rgba(0, 0, 0, 0.18),
      0 1px 3px rgba(0, 0, 0, 0.18);
    display: flex;
    margin-top: 24px;
    margin-bottom: 24px;
    position: relative;
    margin-left: 150px;
    margin-right: 150px;
  }

  .g-2 {
    margin-left: 20px;
  }

  .active-border {
    border-bottom: 3px solid #ff4081 !important;
    border-radius: 5px 5px 0 0 !important;
  }

  #emailModalBody p {
    margin: 4px 0 !important;
    line-height: 1.4;
  }

  #emailModalBody br {
    line-height: 0;
  }

  #emailModalBody img {
    margin: 8px 0;
  }

  .table-bordered {
    margin-top: 20px;
  }

  center {
    margin-left: 20px;
    margin-right: 20px;
  }

  #emailModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
  }

  .closemodal {
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    background-color: #fff;
    color: red;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
{{template "spinner"}}
<div class="card">
  <!-- Patient Dropdown -->
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <br /><label for="patientSelect" class="floating-label"
        >Select Patient :</label
      >
      <select id="patientSelect" style="width: 200px">
        <option value="">Select Patient</option>
        {{range .UniqueRecipients}}
        <option value="{{.}}">{{.}}</option>
        {{end}}
      </select>
      <br /><br />
    </div>
  </div>
  <div id="accessStatus" style="margin-bottom: 10px; font-weight: bold"></div>
  <br />
  <div
    id="showingAllRecordsText"
    style="
      display: none;
      color: gray;
      font-weight: bold;
      margin-top: 10px;
      margin-left: 20px;
    "
  >
    Showing All Records
  </div>
  <!--Prescription Table -->
  <center>
    <table class="table table-bordered border-dark">
      <thead>
        <tr>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Doctor
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Summary of Observation
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Date
          </th>
          <th
            style="
              color: #ffffff;
              background-color: #4caf50;
              text-align: center;
            "
          >
            Attachments
          </th>
        </tr>
      </thead>
      <tbody id="prescriptionTable">
        <tr class="no-records-row">
          <td colspan="4" style="text-align: center; color: gray">
            No Record Found
          </td>
        </tr>
      </tbody>
    </table>
  </center>

  <!-- Email Content Modal -->
  <div id="emailModal">
    <div
      style="
        background: white;
        margin: 5% auto;
        padding: 20px;
        width: 70%;
        border-radius: 12px;
        position: relative;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      "
    >
      <span
        onclick="closeEmailModal()"
        style="
          position: absolute;
          top: 10px;
          right: 15px;
          cursor: pointer;
          font-size: 28px;
          color: #333;
        "
        >&times;</span
      >

      <div id="emailModalBody">‚è≥ Loading...</div>

      <div style="text-align: right; margin-top: 20px">
        <button onclick="closeEmailModal()" class="closemodal">OK</button>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay" onclick="closePopup()"></div>
  <div id="popup" class="popup">
    <div id="popup-content"></div>
  </div>
  <br /><br />

  <div class="row g-2 align-items-center">
    <!-- BACK BUTTON-->
    <div class="col-auto">
      <a
        href="javascript:void(0);"
        class="btn btn-default"
        onclick="handleBackClick()"
        >BACK</a
      >
    </div>

    <!-- ADD PATIENT Button -->
    <div class="col-auto">
      <a
        href="#"
        class="btn btn-default"
        data-bs-toggle="modal"
        data-bs-target="#addptModal"
        >ADD PATIENT</a
      >

      <!-- Add Patient Modal -->
      <div
        class="modal fade"
        id="addptModal"
        tabindex="-1"
        aria-labelledby="addptModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addptModalLabel">Add Patient</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <div
                class="form-floating mb-3"
                style="display: none"
                id="nameInputWrapper"
              >
                <input
                  type="text"
                  id="nameInput"
                  class="form-control"
                  placeholder="Enter Name"
                  autocomplete="off"
                />

                <label for="nameInput">Full Name</label>
              </div>
              <!-- Mobile Number Input -->
              <div class="form-floating mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="mobileInput"
                  placeholder="Enter 10 Digit Mobile"
                  maxlength="10"
                  onkeypress="checkEnter(event)"
                  autocomplete="off"
                />
                <label for="mobileInput">Mobile Number</label>
              </div>

              <!-- OTP Input (Initially Hidden) -->
              <div
                class="form-floating mt-3"
                style="display: none"
                id="otpInput"
              >
                <input
                  type="text"
                  id="addPatientOtpInput"
                  class="form-control"
                  placeholder="Enter Sent OTP"
                  maxlength="6"
                  autocomplete="off"
                />
                <label for="addPatientOtpInput">Enter Sent OTP</label>
              </div>

              <!-- Patient Details Input - shown after OTP success -->
              <!-- Email -->
              <div
                class="form-floating mb-3"
                style="display: none"
                id="emailInputWrapper"
              >
                <input
                  type="email"
                  id="emailInput"
                  class="form-control"
                  placeholder="Email"
                  autocomplete="off"
                />
                <label for="emailInput">Email</label>
              </div>
              <!-- DOB -->
              <div
                class="form-floating mb-3"
                style="display: none"
                id="dobInputWrapper"
              >
                <input
                  type="date"
                  id="dobInput"
                  class="form-control"
                  placeholder="Date of Birth"
                  autocomplete="off"
                />
                <label for="dobInput">Date of Birth</label>
              </div>

              <!-- Gender -->
              <div
                class="form-floating mb-3"
                style="display: none"
                id="genderInputWrapper"
              >
                <input
                  type="text"
                  id="genderInput"
                  class="form-control"
                  placeholder="Gender"
                  autocomplete="off"
                />
                <label for="genderInput">Gender</label>
              </div>
              <!-- üëá Gender Radio Buttons for New Patients -->
              <div class="mb-3" style="display: none" id="genderRadioWrapper">
                <label class="form-label">Gender</label><br />
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="genderRadio"
                    id="maleRadio"
                    value="Male"
                  />
                  <label class="form-check-label" for="maleRadio">Male</label>
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="genderRadio"
                    id="femaleRadio"
                    value="Female"
                  />
                  <label class="form-check-label" for="femaleRadio"
                    >Female</label
                  >
                </div>
              </div>

              <div
                id="chkboxWrapper"
                class="form-check mt-3"
                style="display: none"
              >
                <input type="checkbox" id="chkbox" class="form-check-input" />
                <label for="chkbox" class="form-check-label ms-2"
                  >Allow View All Records</label
                >
              </div>

              <!-- Save Button -->
              <button
                onclick="savePatientData()"
                id="savePatientButton"
                class="btn btn-secondary mt-3"
                style="
                  display: none;
                  width: 100%;
                  margin: 25px auto 3%;
                  box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
                "
              >
                ADD PATIENT
              </button>

              <!-- NEXT / Submit Button -->
              <button
                type="button"
                class="btn btn-secondary mt-3"
                id="nextButton"
                style="
                  width: 100%;
                  margin: 25px auto 3%;
                  box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
                "
                onclick="handleNextClick()"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--  OPD BUTTON-->
    <div class="col-auto">
      <a
        href="javascript:void(0);"
        class="btn btn-default"
        data-patient-id="1"
        rev="opd-link"
      >
        OPD
      </a>
      <div
        class="modal fade"
        id="opdMessageModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <!--  OPD MODAL ERROR-->
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="opdMessageText"
                style="font-size: 18px; margin: 15px 0"
              ></p>
              <div class="d-flex justify-content-end">
                <button
                  type="button"
                  class="btn"
                  style="
                    all: unset;
                    color: red;
                    cursor: pointer;
                    font-size: 16px;
                  "
                  data-bs-dismiss="modal"
                >
                  OK
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--  OPD MODAL-->
      <div
        class="modal fade"
        id="opdModal"
        tabindex="-1"
        aria-labelledby="opdModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="opdModalLabel">OPD</h5>
              <span
                id="patientselect"
                style="font-size: 1.25rem; color: #212529; margin-left: 10px"
              ></span>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <ul class="nav nav-tabs" id="opdTabs" role="tablist">
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="notes-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#notes"
                    type="button"
                    style="color: #ff4081"
                  >
                    OPD NOTES
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="prescription-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#prescription"
                    type="button"
                    style="color: #ff4081"
                  >
                    PRESCRIPTION
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link border-top border-end border-start"
                    id="followup-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#followup"
                    type="button"
                    style="color: #ff4081"
                  >
                    FOLLOW-UP DATE
                  </button>
                </li>
              </ul>
              <div class="tab-content" id="opdTabsContent">
                <div class="tab-pane fade show active" id="notes">
                  <textarea
                    id="notesInput"
                    class="form-control"
                    placeholder="Add OPD Notes"
                    rows="5"
                  ></textarea>
                </div>
                <div class="tab-pane fade" id="prescription">
                  <textarea
                    id="prescriptionInput"
                    class="form-control"
                    placeholder="Add Prescription"
                    rows="5"
                  ></textarea>
                </div>
                <div class="tab-pane fade" id="followup">
                  <div class="mb-3">
                    <label for="followupDate" class="form-label"
                      >Next Followup Date</label
                    >
                    <input
                      type="date"
                      id="followupDate"
                      class="form-control"
                      placeholder="Next Followup Date"
                    />
                    <div class="invalid-feedback">
                      Please select a follow-up date.
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="followupTime" class="form-label"
                      >Next Followup Time</label
                    >
                    <input
                      type="time"
                      id="followupTime"
                      class="form-control"
                      placeholder="Next Followup Time"
                    />
                    <div class="invalid-feedback">
                      Please select a follow-up time.
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Bootstrap Icon Alert with Custom Message -->
            <div
              id="warningAlert"
              class="alert alert-danger d-flex align-items-center d-none mx-3 mt-3"
              role="alert"
            >
              <div id="warningMessage">
                <!-- Dynamic message will be injected here -->
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goToPreviousTab()"
                style="
                  color: #4caf50;
                  background-color: rgba(154, 154, 154, 0.36);
                "
              >
                PREVIOUS
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goToNextTab()"
                style="
                  color: #4caf50;
                  background-color: rgba(154, 154, 154, 0.36);
                "
              >
                NEXT
              </button>
              <button
                type="submit"
                class="btn btn-danger"
                id="saveBtn"
                style="display: none"
                onclick="saveOPDDetails()"
              >
                SAVE
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- View All Records  -->
    <div class="col-auto">
      <!-- View All Records Button -->

      <a href="javascript:void(0);" id="viewRecordsBtn" class="btn btn-default">
        VIEW ALL RECORDS
      </a>

      <!-- View All Record Modal -->
      <div
        class="modal fade"
        id="allrecordModal"
        tabindex="-1"
        aria-labelledby="allrecordModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                Allow access to all records permanently
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Readonly Mobile Number -->
              <input
                type="text"
                id="phoneInput"
                class="form-control"
                placeholder="Enter 10 Digit Mobile"
                maxlength="10"
                readonly
              />

              <!-- OTP Field -->
              <div
                class="form-floating mt-3"
                id="viewAllOtpWrapper"
                style="display: none"
              >
                <input
                  type="text"
                  id="viewAllOtpInput"
                  class="form-control"
                  placeholder="Enter Sent OTP"
                  maxlength="6"
                  autocomplete="off"
                />
                <label for="viewAllOtpInput">Enter Sent OTP</label>
              </div>

              <!-- Button -->
              <button
                type="button"
                class="btn btn-secondary mt-4"
                id="nextBtn"
                style="width: 100%; box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3)"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- OTP Success Modal -->
      <div class="modal fade" id="otpSuccessModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="otpSuccessText"
                class="text-success"
                style="font-size: 18px"
              ></p>
              <button
                type="button"
                class="btn"
                style="
                  all: unset;
                  color: green;
                  cursor: pointer;
                  font-size: 16px;
                "
                data-bs-dismiss="modal"
                onclick="closeAllRecordModal()"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- OTP Error Modal -->
      <div class="modal fade" id="otpErrorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p
                id="otpErrorText"
                class="text-danger"
                style="font-size: 18px"
              ></p>
              <button
                type="button"
                class="btn"
                style="all: unset; color: red; cursor: pointer; font-size: 16px"
                data-bs-dismiss="modal"
                onclick="keepOtpVisibleAfterError()"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Modal for OPD -->
      <div class="modal fade" id="opdMessageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body text-center">
              <p id="opdMessageText" style="font-size: 18px"></p>
              <button
                type="button"
                class="btn"
                style="
                  all: unset;
                  color: #007bff;
                  cursor: pointer;
                  font-size: 16px;
                "
                data-bs-dismiss="modal"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br /><br /><br />
</div>

<script>
  
  window.addEventListener("DOMContentLoaded", function () {
    const dropdown = document.getElementById("patientSelect");
    const modalTitle = document.getElementById("opdModalLabel");

    const restorePatient = localStorage.getItem("restorePatient") === "true";
    const savedPatient = localStorage.getItem("selectedPatient");

    populatePatientDropdown().then(() => {
      if (restorePatient && savedPatient) {
        dropdown.value = savedPatient;
        dropdown.dispatchEvent(new Event("change"));
      }
      localStorage.removeItem("restorePatient");
      localStorage.removeItem("selectedPatient");
    });

    dropdown.addEventListener("change", () => {
      const mobileNumber = dropdown.value?.split("@")[0];
      if (mobileNumber) modalTitle.textContent = `OPD - ${mobileNumber}`;
    });

    document.querySelectorAll('a[rev="opd-link"]').forEach((opdBtn) => {
      opdBtn.addEventListener("click", () => {
        if (!dropdown.value) {
          document.getElementById("opdMessageText").textContent =
            "Please select a patient to proceed further.";
          new bootstrap.Modal(
            document.getElementById("opdMessageModal")
          ).show();
          return;
        }

        const mobile = dropdown.value.split("@")[0];
        modalTitle.textContent = `OPD - ${mobile}`;
        new bootstrap.Modal(document.getElementById("opdModal")).show();
      });
    });
  });
 
  async function populatePatientDropdown() {
    const dropdown = document.getElementById("patientSelect");
    dropdown.innerHTML = '<option value="">Loading patients...</option>';
  
    try {
      const response = await fetch("/get-recipients");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
  
      const data = await response.json();
      dropdown.innerHTML = '<option value="">Select Patient</option>'; // Clear after fetch
  
      const uniqueMobiles = new Set();
  
      data.forEach(({ mobile, name }) => {
        const trimmedMobile = mobile?.trim();
        const displayName = name?.trim() || trimmedMobile;
  
        if (trimmedMobile && !uniqueMobiles.has(trimmedMobile)) {
          uniqueMobiles.add(trimmedMobile);
          const option = document.createElement("option");
  
          // Now just store mobile, no domain
          option.value = trimmedMobile;
          option.textContent = displayName;
  
          dropdown.appendChild(option);
        }
      });
    } catch (error) {
      console.error("Error fetching patient list:", error);
      dropdown.innerHTML = '<option value="">Failed to load patients</option>';
    }
  }
  
  function checkAccessAndRefresh() {
    const selectedPatientId = document.getElementById("patientSelect").value;
    const doctorId = loggedInEmail;
    const statusMessage = document.getElementById("accessStatus");

    if (!selectedPatientId) {
      statusMessage.innerText = "";
      document.getElementById("prescriptionTable").innerHTML = `
        <tr><td colspan="4" style="text-align:center; color: gray;">No Record Found</td></tr>`;
      return;
    }

    fetch(
      `/check-access?doctorId=${encodeURIComponent(
        doctorId
      )}&patientId=${encodeURIComponent(selectedPatientId)}`
    )
      .then((res) => res.json())
      .then((data) => {
        const access = data.hasAccess;
        const showingText = document.getElementById("showingAllRecordsText");
        const viewBtn = document.getElementById("viewRecordsBtn");

        if (access === "Y") {
          statusMessage.innerHTML = `<span style="color: green;">‚úÖ Data Access Granted</span>`;
          showingText.style.display = "block";
          viewBtn.style.display = "none";
        } else {
          const msg =
            access === "N" ? "‚ùå Access Not Granted" : "‚ùå No Record Found";
          statusMessage.innerHTML = `<span style="color: red;">${msg}</span>`;
          showingText.style.display = "none";
          viewBtn.style.display = "block";
        }

        filterPrescriptionTable();
      })
      .catch((err) => {
        console.error("‚ùå Error checking access:", err);
        statusMessage.innerHTML = `<span style="color: red;">‚ùå Error checking access</span>`;
        filterPrescriptionTable();
      });
  }

  document
    .getElementById("patientSelect")
    .addEventListener("change", checkAccessAndRefresh);

  function filterPrescriptionTable() {
    const selectedTo = document.getElementById("patientSelect").value;
    const tableBody = document.getElementById("prescriptionTable");

    if (!selectedTo) {
      tableBody.innerHTML = `
        <tr><td colspan="4" style="text-align:center; color: gray;">No Record Found</td></tr>`;
      return;
    }

    showSpinner();

    fetch(`/emails?to=${encodeURIComponent(selectedTo)}`, {
      headers: { "X-Requested-With": "XMLHttpRequest" },
    })
      .then((response) => {
        if (response.redirected) {
          alert("Session expired. Redirecting to login.");
          window.location.href = "/login";
          return Promise.reject("Redirected due to expired session.");
        }
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        const emails = data.emails || [];
        const html = emails
          .map((email) => {
            const fromName = email.from_name || "Unknown";
            const subject = email.subject || "(No Subject)";
            const date = email.date || "No Date";
            const attachments =
              (email.attachment_names || [])
                .map(
                  (name) =>
                    `<a href="javascript:void(0);" onclick="renderAttachments(${email.uid}, '${name}')" style="color: red; text-decoration: none;">${name}</a>`
                )
                .join(", ") || "No Attachments";

            return `
            <tr>
              <td>${fromName}</td>
              <td>
                <a href="javascript:void(0);" onclick="fetchAndShowEmailBody('${email.uid}')"
                  style="color: red; text-decoration: none;">${subject}</a>
              </td>
              <td>${date}</td>
              <td>${attachments}</td>
            </tr>`;
          })
          .join("");

        tableBody.innerHTML =
          html ||
          `
          <tr><td colspan="4" style="text-align: center; color: gray;">No Record Found</td></tr>`;
        hideSpinner();
      })
      .catch((err) => {
        console.error("‚ùå Fetch error:", err);
        tableBody.innerHTML = `
          <tr><td colspan="4" style="color: red; text-align: center;">Error loading emails.</td></tr>`;
        hideSpinner();
      });
  }
  const addPatientModal = document.getElementById("addptModal");

  addPatientModal.addEventListener("show.bs.modal", () => {
    // Reset input values
    document.getElementById("mobileInput").value = "";
    document.getElementById("addPatientOtpInput").value = "";
    document.getElementById("nameInput").value = "";
    document.getElementById("emailInput").value = "";
    document.getElementById("dobInput").value = "";
    document.getElementById("genderInput").value = "";
    document.getElementById("chkbox").checked = false;
    document.getElementById("chkbox").disabled = false;
  
    // Hide all form sections except mobile + Next button
    [
      "otpInput",
      "nameInputWrapper",
      "emailInputWrapper",
      "dobInputWrapper",
      "genderInputWrapper",
      "genderRadioWrapper",
      "chkboxWrapper",
      "savePatientButton",
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    });
  
    // Show only Next button
    document.getElementById("nextButton").style.display = "block";
  });
  
  // Function to save patient data
  function savePatientData() {
    const name = document.getElementById("nameInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    const dob = document.getElementById("dobInput").value.trim();
    const gender =
      document.getElementById("genderInputWrapper").style.display === "block"
        ? document.getElementById("genderInput").value.trim()
        : document.querySelector("input[name='genderRadio']:checked")?.value;
    const mobile = document.getElementById("mobileInput").value.trim();
    const doctorId = loggedInEmail?.trim(); // assuming loggedInEmail is globally defined
    const hasAccess = document.getElementById("chkbox").checked ? "Y" : "N";
  
    // Validate required fields
    if (!name || !dob || !gender || !mobile || !doctorId) {
      alert("‚ùå Please fill all the required fields.");
      return;
    }
  
    const payload = {
      name,
      email,
      dob,
      gender,
      mobile,
      doctorId,
      hasAccess,
    };
  
    console.log("üì§ Submitting patient data:", payload);
    showSpinner();
    fetch("/save-patient", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("‚úÖ Save response:", data);
        if (data.success) {
          console.log("üéâ Patient saved successfully!");
          const addPatientModalEl = document.getElementById("addptModal");
          let addPatientModal = bootstrap.Modal.getInstance(addPatientModalEl);
          if (!addPatientModal) {
            addPatientModal = new bootstrap.Modal(addPatientModalEl);
          }
          addPatientModal.hide();
          hideSpinner();
          location.reload();
        } else {
          alert("‚ö†Ô∏è Failed to save patient: " + (data.message || "Unknown error."));
          hideSpinner();
        }
      })
      .catch((err) => {
        console.error("‚ùå Error saving patient:", err);
        alert("‚ö†Ô∏è Something went wrong. Try again.");
      });
  }
  function handleNextClick() {
    const mobileInput = document.getElementById("mobileInput");
    const otpInput = document.getElementById("otpInput");
    const nextButton = document.getElementById("nextButton");
  
    const mobileNumber = mobileInput.value.trim();
  
    if (!/^\d{10}$/.test(mobileNumber)) {
      alert("‚ùå Please enter a valid 10-digit mobile number");
      return;
    }
  
    // Generate OTP
    fetch("/generate-otp-card", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ mobile: mobileNumber }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          otpInput.style.display = "block";
          mobileInput.setAttribute("readonly", true);
          nextButton.textContent = "Submit";
  
          // Set onclick using an anonymous function to pass the event
          nextButton.onclick = function (event) {
            submitOtpAddPatient(event);
          };
        } else {
          alert("‚ùå Failed to generate OTP");
        }
      })
      .catch((err) => {
        console.error("OTP generation failed:", err);
        alert("‚ö†Ô∏è Could not generate OTP. Try again.");
      });
  }
  
  // Submit OTP for Add Patient modal
  function submitOtpAddPatient(event) {
    // Prevent any form submission that might trigger a page refresh
    event.preventDefault();
  
    console.log("üîç submitOtpAddPatient triggered");
  
    const mobile = document.getElementById("mobileInput")?.value.trim();
    const otp = document.getElementById("addPatientOtpInput")?.value.trim();
    const doctorId = loggedInEmail?.trim();
  
    console.log("üì§ Collected Values ‚Üí", { mobile, otp, doctorId });
  
    // Check if required fields are filled
    if (!mobile || !otp || !doctorId) {
      const otpErrorModal = new bootstrap.Modal(document.getElementById("otpErrorModal"));
      document.getElementById("otpErrorText").textContent = "‚ùå Missing required fields.";
      otpErrorModal.show();
      return;
    }
  
    // Initiate OTP verification
    fetch("/verify-otp-card", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ mobile, otp }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("üì• OTP Verification Response:", data);
  
        const isOtpSuccess = data.success === true || data.success === "true";
  
        if (isOtpSuccess) {
          console.log("‚úÖ OTP Verified. Now checking MongoDB...");
  
          // Hide OTP input and next button
          ["otpInput", "nextButton"].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.style.display = "none";
          });
  
          // Show post-OTP fields
          [
            "afterOtpInput",
            "nameInputWrapper",
            "emailInputWrapper",
            "dobInputWrapper",
            "genderInputWrapper",
            "chkboxWrapper",
            "savePatientButton",
          ].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.style.display = "block";
          });
  
          document.getElementById("savePatientButton").disabled = false;
  
          // Call MongoDB check
          checkPatientInMongo(mobile, doctorId);
        } else {
          console.warn("‚ùå OTP Verification Failed.");
          const errorModal = new bootstrap.Modal(document.getElementById("otpErrorModal"));
          document.getElementById("otpErrorText").textContent = "‚ùå " + (data.error || "Invalid OTP.");
          errorModal.show();
        }
      })
      .catch((err) => {
        console.error("‚ùå OTP Verification Error (Network or Server):", err);
        const errorModal = new bootstrap.Modal(document.getElementById("otpErrorModal"));
        document.getElementById("otpErrorText").textContent = "‚ö†Ô∏è Something went wrong. Try again.";
        errorModal.show();
      });
  }
  
  // Optional: Clear fields when modal closes
  document
    .getElementById("addptModal")
    .addEventListener("hidden.bs.modal", () => {
      // Reset form values
      const mobileInput = document.getElementById("mobileInput");
      const otpInput = document.getElementById("otpInput");
      const afterOtpInput = document.getElementById("afterOtpInput");
      const nextBtn = document.getElementById("nextButton");
  
      mobileInput.value = "";
      otpInput.value = "";
      otpInput.style.display = "none";
      mobileInput.removeAttribute("readonly");
  
      if (afterOtpInput) afterOtpInput.style.display = "none";
  
      // Reset Next Button
      nextBtn.textContent = "Next";
      nextBtn.style.display = "block";
      nextBtn.onclick = handleNextClick;
    });
    function checkPatientInMongo(mobile, doctorId) {
    console.log(
      `üîç Checking MongoDB for patient with mobile: ${mobile} and doctorId: ${doctorId}`
    );
    const today = new Date().toISOString().split("T")[0];

    fetch(
      `/check-patient?mobile=${encodeURIComponent(
        mobile
      )}&doctorId=${encodeURIComponent(doctorId)}`
    )
      .then((res) => res.json())
      .then((data) => {
        const nameInput = document.getElementById("nameInput");
        const emailInput = document.getElementById("emailInput");
        const dobInput = document.getElementById("dobInput");
        const genderInput = document.getElementById("genderInput");
        const chkbox = document.getElementById("chkbox");

        const genderInputWrapper =
          document.getElementById("genderInputWrapper");
        const genderRadioWrapper =
          document.getElementById("genderRadioWrapper");
        dobInput.max = today;
        if (data.exists) {
          console.log("‚úÖ Patient exists in DB:", data);

          // Autofill data
          nameInput.value = data.name || "";
          emailInput.value = data.email || "";
          dobInput.value = data.dob || "";
          genderInput.value = data.gender || "";

          // Make inputs read-only
          nameInput.readOnly = true;
          emailInput.readOnly = true;
          dobInput.readOnly = true;
          genderInput.readOnly = true;

          // Show text input, hide radio buttons
          genderInputWrapper.style.display = "block";
          genderRadioWrapper.style.display = "none";

          // ‚úÖ Handle checkbox based on boolean access
          if (data.hasAccess === true) {
            chkbox.checked = true; // ‚úÖ Mark as checked
            chkbox.disabled = false; // ‚úèÔ∏è Keep editable
          } else {
            chkbox.checked = false;
            chkbox.disabled = false;
          }
        } else {
          console.log("üÜï New patient. Preparing blank form...");

          // Clear and enable all input fields
          nameInput.value = "";
          emailInput.value = "";
          dobInput.value = "";
          genderInput.value = "";
          chkbox.checked = false;

          nameInput.readOnly = false;
          emailInput.readOnly = false;
          dobInput.readOnly = false;

          // Hide text input and show gender radio buttons
          genderInputWrapper.style.display = "none";
          genderRadioWrapper.style.display = "block";

          document
            .querySelectorAll("input[name='genderRadio']")
            .forEach((r) => (r.checked = false));
          chkbox.disabled = false;
        }
      })
      .catch((err) => {
        console.error("‚ùå Error while checking MongoDB:", err);
      });
  }

  // ‚úÖ Clear fields when modal is closed
  document
    .getElementById("addptModal")
    .addEventListener("hidden.bs.modal", () => {
      const mobileInput = document.getElementById("mobileInput");
      const otpInput = document.getElementById("otpInput");
      const afterOtpInput = document.getElementById("afterOtpInput");
      const nextBtn = document.getElementById("nextButton");

      mobileInput.value = "";
      otpInput.value = "";
      otpInput.style.display = "none";
      mobileInput.removeAttribute("readonly");

      if (afterOtpInput) afterOtpInput.style.display = "none";

      nextBtn.textContent = "Next";
      nextBtn.style.display = "block";
      nextBtn.onclick = handleNextClick;
    });

  // ‚úÖ Optional: Clear fields when OPD modal closes
  document
    .getElementById("opdModal")
    .addEventListener("hidden.bs.modal", () => {
      const notes = document.getElementById("notesInput");
      const prescription = document.getElementById("prescriptionInput");
      notes.value = "";
      prescription.value = "";
      document.getElementById("followupDate").value = "";
      document.getElementById("followupTime").value = "";
    });

  // Open Modal and set mobile
  document
    .getElementById("viewRecordsBtn")
    .addEventListener("click", function () {
      const dropdown = document.getElementById("patientSelect");
      const selectedPatient = dropdown.value;

      if (!selectedPatient) {
        document.getElementById("opdMessageText").textContent =
          "Please Select Patient to proceed further.";
        new bootstrap.Modal(document.getElementById("opdMessageModal")).show();
      } else {
        const mobile = selectedPatient.split("@")[0];
        document.getElementById("phoneInput").value = mobile;

        new bootstrap.Modal(document.getElementById("allrecordModal")).show();
      }
    });

  // When modal opens - reset it
  document
    .getElementById("allrecordModal")
    .addEventListener("show.bs.modal", function () {
      const dropdown = document.getElementById("patientSelect");
      const selectedValue = dropdown.value;

      const mobileOnly = selectedValue.split("@")[0];
      const mobileInput = document.getElementById("phoneInput");

      mobileInput.value = mobileOnly;
      mobileInput.setAttribute("readonly", true);

      // Reset OTP input (new floating structure)
      const otpWrapper = document.getElementById("viewAllOtpWrapper");
      const otpInput = document.getElementById("viewAllOtpInput");

      otpWrapper.style.display = "none";
      otpInput.value = "";

      const nextBtn = document.getElementById("nextBtn");
      nextBtn.textContent = "Next";
      nextBtn.onclick = viewRecordOtpInput;
    });

  // Show OTP Field & call backend
  function viewRecordOtpInput() {
    const mobileInput = document.getElementById("phoneInput");
    const otpInput = document.getElementById("viewAllOtpInput");
    const otpWrapper = document.getElementById("viewAllOtpWrapper");
    const nextBtn = document.getElementById("nextBtn");

    const mobileNumber = mobileInput.value.trim();
    if (!/^\d{10}$/.test(mobileNumber)) {
      alert("Please enter a valid 10-digit mobile number");
      return;
    }

    fetch("/generate-otp-card", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ mobile: mobileNumber }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          otpWrapper.style.display = "block"; // ‚úÖ Corrected this line
          mobileInput.setAttribute("readonly", true);
          nextBtn.textContent = "Submit";
          nextBtn.onclick = submitOtp;
        } else {
          alert("‚ùå Failed to generate OTP");
        }
      })
      .catch((err) => {
        console.error("OTP generation failed:", err);
        alert("‚ö†Ô∏è Could not generate OTP. Try again.");
      });
  }

  // Submit OTP
  function submitOtp() {
    const otp = document.getElementById("viewAllOtpInput").value.trim();
    const mobile = document.getElementById("phoneInput").value.trim();

    if (!otp) {
      const errorModal = new bootstrap.Modal(
        document.getElementById("otpErrorModal")
      );
      document.getElementById("otpErrorText").textContent =
        "Please enter the OTP";
      errorModal.show();
      return;
    }

    fetch("/verify-otp-card", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ mobile, otp }),
    })
      .then((res) => {
        if (!res.ok)
          throw new Error("OTP verification failed with server error");
        return res.json();
      })
      .then((data) => {
        console.log("‚úÖ OTP verification response:", data);

        if (data.success) {
          console.log("‚úÖ OTP verified, proceeding to update access...");
          const doctorId = loggedInEmail;
          const patientId = mobile + "@reportsofme.com";

          fetch("/update-access", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ doctorId, patientId }),
          })
            .then((res) => res.json())
            .then((accessData) => {
              console.log("‚úÖ Access update response:", accessData);
              closeAllRecordModal(); // Hide modal & reload with patient selection
            })
            .catch((err) => {
              console.error("‚ùå Access update failed:", err);
              alert("‚ö†Ô∏è Access update failed. Please try again later.");
            });
        } else {
          const errorModal = new bootstrap.Modal(
            document.getElementById("otpErrorModal")
          );
          document.getElementById("otpErrorText").textContent =
            "‚ùå " + (data.error || "Invalid OTP");
          errorModal.show();
          keepOtpVisibleAfterError?.(); // Optional chaining if function exists
        }
      })
      .catch((err) => {
        console.error("‚ùå OTP verification failed:", err);
        const errorModal = new bootstrap.Modal(
          document.getElementById("otpErrorModal")
        );
        document.getElementById("otpErrorText").textContent =
          "‚ö†Ô∏è Something went wrong. Try again.";
        errorModal.show();
        keepOtpVisibleAfterError?.(); // Optional chaining
      });
  }

  // Keep OTP field visible after error
  function keepOtpVisibleAfterError() {
    const otpWrapper = document.getElementById("viewAllOtpWrapper");
    const otpInput = document.getElementById("viewAllOtpInput");

    otpWrapper.style.display = "block"; // Show the floating input wrapper
    otpInput.value = ""; // Clear any existing OTP input
  }
  function closeAllRecordModal() {
    const modal = bootstrap.Modal.getInstance(
      document.getElementById("allrecordModal")
    );
    if (modal) modal.hide();
  
    // UI updates ‚Äî refresh view
    document.getElementById("showingAllRecordsText").style.display = "block";
    document.getElementById("viewRecordsBtn").style.display = "none";
  
    // Refresh prescription/email table logic without reload
    if (typeof filterPrescriptionTable === "function") {
      filterPrescriptionTable(); // Calls your data reload logic
    }
  }
  function handleBackClick() {
    fetch("/dashboard", {
      method: "GET",
      headers: { "X-Requested-With": "XMLHttpRequest" },
    })
      .then((response) => {
        if (response.redirected || response.status === 401) {
          setTimeout(() => {
            alert("Session expired. Redirecting to login.");
            window.location.href = "/login";
          }, 0);
          throw new Error("Session expired");
        }

        // If session is still valid, navigate
        window.location.href = "/dashboard";
      })
      .catch((err) => {
        console.error("‚ùå BACK navigation error:", err);
      });
  }

  var loggedInEmail = "{{.Email}}";
  console.log("üë§ Logged-in email:", loggedInEmail);

  // If session expired (Email not present), block all interaction and redirect
  if (!loggedInEmail || loggedInEmail.trim() === "") {
    console.warn(
      "üö® Session expired. Blocking interaction and redirecting to login..."
    );

    // Prevent all clicks on buttons, links, etc.
    document.addEventListener(
      "click",
      function (e) {
        const target = e.target.closest("a, button");
        if (!target) return;

        // Ping your existing EmailHandler route (AJAX)
        fetch(window.location.pathname, {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest", // triggers AJAX branch in your handler
          },
        })
          .then((response) => {
            if (response.redirected) {
              console.warn(
                "üîí Session expired (redirected response). Redirecting to /login"
              );
              e.preventDefault();
              window.location.href = "/login";
            } else {
              // Optional: still check if response contains error JSON
              return response
                .json()
                .then((data) => {
                  if (data?.error === "Recipient email is required") {
                    console.warn(
                      "üîí AJAX session invalid (bad request). Redirecting."
                    );
                    e.preventDefault();
                    window.location.href = "/login";
                  }
                })
                .catch(() => {
                  /* not JSON? do nothing */
                });
            }
          })
          .catch((err) => {
            console.error("‚ùå Error checking session:", err);
            e.preventDefault();
            window.location.href = "/login";
          });
      },
      true
    );
    // Optional UI message
    alert("Session expired. Redirecting to login...");

    // Redirect to login
    window.location.href = "/login";
  }

  document.addEventListener("DOMContentLoaded", function () {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("followupDate").setAttribute("min", today);
  });

  // Function to call PDF generation
  function generatePDF() {
    const dropdown = document.getElementById("patientSelect");
    const selectedValue = dropdown.value;

    if (!selectedValue) {
      alert("Please select a patient.");
      return;
    }

    // Extract only the mobile number part
    const mobileNumber = selectedValue.split("@")[0];

    fetch("/generate-pdf", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ patientEmail: mobileNumber }), // send only mobile number
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.message) {
          alert("‚úÖ " + data.message);
        } else {
          alert("‚ùå Error: " + data.error);
        }
      })
      .catch((error) => {
        console.error("PDF generation failed:", error);
        alert("‚ùå PDF generation request failed.");
      });
  }

  function logout() {
    fetch("/logout", { method: "GET" })
      .then((response) => {
        if (response.redirected) {
          window.location.href = response.url; // Redirect to login page
        }
      })
      .catch((error) => console.error("Logout failed:", error));
  }

  function fetchAndShowEmailBody(uid) {
    // Show the global spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    fetch(`/get-email-body?uid=${uid}`)
      .then((response) => {
        // ‚úÖ Session expired: Redirected to /login
        if (response.redirected) {
          alert("Session expired. Redirecting to login.");
          window.location.href = "/login";
          return Promise.reject("Redirected due to expired session.");
        }

        return response.json();
      })
      .then((data) => {
        // Hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");

        // Handle any errors from the server
        if (data.error) {
          alert(data.error);
          return;
        }

        // Format body content
        let bodyContent = data.plainTextBody
          ? data.plainTextBody
              .replace(/\r\n/g, "<br>")
              .replace(/\n/g, "<br>")
              .replace(/(<br\s*\/?>\s*){2,}/g, "<br>")
              .trim()
          : "<p>No content available</p>";

        // Format image attachments
        let attachmentsHtml = "";
        if (data.attachments && data.attachments.length > 0) {
          attachmentsHtml = data.attachments
            .map((att) =>
              att.type === "image"
                ? `<img src="${att.base64}" alt="${att.name}" style="max-width: 300px; margin: 10px 0;"><br>`
                : ""
            )
            .join("");
        }

        // Inject email body + attachments
        document.getElementById("emailModalBody").innerHTML =
          bodyContent + attachmentsHtml;

        // Show modal
        document.getElementById("emailModal").style.display = "block";
      })
      .catch((err) => {
        // Only log errors if not redirected
        if (err !== "Redirected due to expired session.") {
          console.error("Error fetching email body:", err);
          document.getElementById(
            "emailModalBody"
          ).innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
          document.getElementById("spinner-overlay").classList.add("hidden");
        }
      });
  }

  function closeEmailModal() {
    document.getElementById("emailModal").style.display = "none";
  }

  function renderAttachments(uid, attachmentName) {
    if (!uid || !attachmentName) {
      alert("Invalid email ID or attachment name.");
      return;
    }

    const url = `/get-attachment?uid=${encodeURIComponent(
      uid
    )}&attachmentName=${encodeURIComponent(attachmentName)}`;
    const newTab = window.open("", "_blank");

    if (!newTab) {
      alert("Popup blocked! Please allow popups for this website.");
      return;
    }

    // Show global spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    fetch(url)
      .then((response) => {
        // ‚úÖ Check if session expired and user was redirected
        if (response.redirected) {
          newTab.close();
          setTimeout(() => {
            alert("Session expired. Redirecting to login.");
            window.location.href = "/login";
          }, 0);
          throw new Error("Session expired - redirected");
        }
        if (!response.ok) {
          if (response.status === 401) throw new Error("Session expired");
          if (response.status === 404) throw new Error("Attachment not found");
          throw new Error(`Error: ${response.status} ${response.statusText}`);
        }
        return response.blob();
      })
      .then((blob) => {
        const fileUrl = URL.createObjectURL(blob);
        const fileType = blob.type;

        newTab.document.open();
        newTab.document.title = attachmentName;

        if (fileType.startsWith("image/")) {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><h3>${attachmentName}</h3>
          <img src="${fileUrl}" style="max-width: 100%; height: auto;" />
          </body></html>`);
        } else if (fileType === "application/pdf") {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><iframe src="${fileUrl}" width="100%" height="100%" style="border:none; height: 95vh;"></iframe>
          </body></html>`);
        } else {
          newTab.document.write(`
          <html><head><title>${attachmentName}</title></head>
          <body><h3>Download attachment:</h3>
          <a href="${fileUrl}" download="${attachmentName}">${attachmentName}</a>
          </body></html>`);
        }
        newTab.document.close();
      })
      .catch((err) => {
        console.error("‚ùå Error fetching attachment:", err);
        if (newTab && !newTab.closed) {
          newTab.document.body.innerHTML = `<h3>Failed to load attachment.</h3><p>${
            err.message || err
          }</p>`;
        }
      })
      .finally(() => {
        // ‚úÖ Always hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");
      });
  }

  function downloadAttachment(uid, attachmentName) {
    // Validate parameters
    if (!uid || uid === "0") {
      alert("Invalid email ID");
      return;
    }

    // Construct the URL
    const url = `/get-attachment?uid=${encodeURIComponent(
      uid
    )}&attachmentName=${encodeURIComponent(attachmentName)}`;

    // Show spinner
    document.getElementById("spinner-overlay").classList.remove("hidden");

    // Pre-validate that the file exists before opening
    fetch(url, { method: "HEAD" }) // Using HEAD just to check if the file exists
      .then((response) => {
        if (!response.ok) {
          if (response.status === 401) throw new Error("Session expired");
          if (response.status === 404) throw new Error("Attachment not found");
          throw new Error("Unable to download the file.");
        }

        // File is valid ‚Äî open in new tab
        window.open(url, "_blank");
      })
      .catch((err) => {
        if (err.message === "Session expired") {
          alert("Your session has expired. Please log in again.");
          window.location.href = "/login";
        } else {
          alert(err.message);
        }
      })
      .finally(() => {
        // Always hide spinner
        document.getElementById("spinner-overlay").classList.add("hidden");
      });
  }

  function openEmailModal(element) {
    var emailBody = element.getAttribute("data-body") || "(No body available)";
    var attachmentsData = element.getAttribute("data-attachments");
    var modalBody = document.getElementById("modalBodyContent");

    modalBody.innerHTML = "<p>" + emailBody.replace(/\n/g, "<br>") + "</p>"; // Ensure line breaks display properly

    let attachmentHTML = ""; // ‚úÖ Initialize the variable

    if (attachmentsData && attachmentsData.trim() !== "") {
      let attachmentsArray = attachmentsData
        .split(";")
        .filter((item) => item.trim() !== "");

      attachmentsArray.forEach((item) => {
        let parts = item.split("|");
        if (parts.length < 2) return;

        let filename = parts[0].trim();
        let mimeType = parts[1].trim();
        let filePath = "attachments/" + encodeURIComponent(filename);

        attachmentHTML += `
              <div style="margin-bottom: 10px;">
                  <span style="font-weight: bold;">‚¨á 
                      <a href="${filePath}" target="_blank" style="text-decoration: none; color: blue;">${filename}</a>
                  </span><br>`;

        if (mimeType.startsWith("image/")) {
          attachmentHTML += `<a href="${filePath}" target="_blank">
                  <img src="${filePath}" alt="${filename}" 
                      style="max-width: 100%; height: auto; display: block; margin-top: 5px; 
                      border: 1px solid #ccc; padding: 5px;">
              </a>`;
        }
        attachmentHTML += `</div>`; // Close div for spacing
      });
    }

    modalBody.innerHTML += attachmentHTML; // ‚úÖ Append attachments if available

    var modal = new bootstrap.Modal(document.getElementById("emailModal"));
    modal.show();
  }

  // Function to decode HTML entities
  function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
  }

  function showPopup(body) {
    document.getElementById("modalBodyContent").innerHTML = body;
    var emailModal = new bootstrap.Modal(document.getElementById("emailModal"));
    emailModal.show();
  }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("overlay").style.display = "none";
  }
  let fromName = "{{.FromName}}"; // Injected from controller

  function saveOPDDetails() {
    let mobileNumber = document.getElementById("patientSelect").value;
    let opdNotes = document.querySelector("#notes textarea").value.trim();
    let prescription = document
      .querySelector("#prescription textarea")
      .value.trim();
    let followupDateEl = document.getElementById("followupDate");
    let followupTimeEl = document.getElementById("followupTime");
    let followupDate = followupDateEl.value.trim();
    let followupTime = followupTimeEl.value.trim();

    let currentDateTime = new Date()
      .toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
      })
      .replace(",", "");

    followupDateEl.classList.remove("is-invalid");
    followupTimeEl.classList.remove("is-invalid");

    let isValid = true;
    if (!followupDate) {
      followupDateEl.classList.add("is-invalid");
      isValid = false;
    }
    if (!followupTime) {
      followupTimeEl.classList.add("is-invalid");
      isValid = false;
    }

    if (!isValid) {
      alert(
        "‚ö†Ô∏è Please fill Follow-up Date and Follow-up Time before generating PDF."
      );
      return;
    }

    // ‚úÖ Show spinner before sending request
    showSpinner();

    fetch("/generate-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: mobileNumber.split("@")[0],
        opdNotes: opdNotes,
        prescription: prescription,
        followupDate: followupDate,
        followupTime: followupTime,
        doctorName: fromName,
        generatedDateTime: currentDateTime,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        // ‚úÖ Hide spinner before showing alert
        hideSpinner();

        if (data.error) {
          console.log("PDF not generated:", data.error);
          alert("‚ùå Error: " + data.error);
          return;
        }

        if (data.message) {
          alert("‚úÖ PDF generated and sent to Patient email");
          filterPrescriptionTable();

          let opdModal = document.getElementById("opdModal");
          let modalInstance = bootstrap.Modal.getInstance(opdModal);
          if (modalInstance) {
            modalInstance.hide();
          } else {
            let newModalInstance = new bootstrap.Modal(opdModal);
            newModalInstance.hide();
          }
        } else {
          alert("‚ùå Error: " + data.error);
        }
      })
      .catch((error) => {
        hideSpinner(); // ‚úÖ Ensure spinner is hidden on error too
        console.error("‚ùå Error generating PDF:", error);
        alert("‚ùå Something went wrong while generating the PDF.");
      });
  }

  function updateTable(entry) {
    let table = document.querySelector("table tbody");
    let row = document.createElement("tr");

    row.innerHTML = `
                    <td>${entry.doctor}</td>
                    <td><a href="#" onclick="showPopup('${
                      entry.opdNotes
                    }')" style="color: red; text-decoration: none;">${entry.opdNotes.substring(
      0,
      30
    )}...</a></td>
                    <td>${entry.followupDate}</td>
                    <td>No attachments</td>
                `;

    table.appendChild(row);
  }

  /*Shuffling of Tabs*/
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll("#opdTabs button");
    const tabContents = document.querySelectorAll(".tab-pane");
    const saveBtn = document.getElementById("saveBtn");
    const nextBtn = document.querySelector(
      ".modal-footer button[onclick='goToNextTab()']"
    );
    const prevBtn = document.querySelector(
      ".modal-footer button[onclick='goToPreviousTab()']"
    );

    // Disable manual clicking on tabs
    tabs.forEach((tab) => {
      tab.setAttribute("disabled", "true");
    });

    function updateButtons() {
      let tabs = document.querySelectorAll("#opdTabs button");
      let activeTab = document.querySelector(".tab-pane.show.active");

      // Remove active-border class from all buttons
      tabs.forEach((tab) => {
        tab.classList.remove("active-border");
      });

      // Highlight the active tab button
      let activeTabButton = document.querySelector(
        `#opdTabs button[data-bs-target="#${activeTab.id}"]`
      );
      if (activeTabButton) {
        activeTabButton.classList.add("active-border");
      }

      // Find index of active tab
      let tabPanes = document.querySelectorAll(".tab-pane");
      let activeIndex = Array.from(tabPanes).findIndex((tab) =>
        tab.classList.contains("show")
      );

      // Show/hide buttons correctly
      prevBtn.style.display = activeIndex === 0 ? "none" : "inline-block";
      nextBtn.style.display =
        activeIndex === tabPanes.length - 1 ? "none" : "inline-block";
      saveBtn.style.display =
        activeIndex === tabPanes.length - 1 ? "inline-block" : "none"; // Fix SAVE button issue
    }

    function showWarning(message) {
      const alertBox = document.getElementById("warningAlert");
      const warningMessage = document.getElementById("warningMessage");

      warningMessage.textContent = message;
      alertBox.classList.remove("d-none");

      setTimeout(() => {
        alertBox.classList.add("d-none");
      }, 2000); // hide after 3 seconds
    }

    function validateCurrentTab() {
      let activeTab = document.querySelector(".tab-pane.show.active");
      let isValid = true;

      if (activeTab.id === "notes") {
        let opdNotes = document.querySelector("#notes textarea").value.trim();
        if (opdNotes === "") {
          showWarning("OPD Notes cannot be empty.");
          isValid = false;
        }
      } else if (activeTab.id === "prescription") {
        let prescription = document
          .querySelector("#prescription textarea")
          .value.trim();
        if (prescription === "") {
          showWarning("Prescription cannot be empty.");
          isValid = false;
        }
      } else if (activeTab.id === "followup") {
        let followupDate = document.querySelector(
          "#followup input[type='date']"
        ).value;
        let followupTime = document.querySelector(
          "#followup input[type='time']"
        ).value;
        if (followupDate === "" || followupTime === "") {
          showWarning("Please select both Follow-up Date and Time.");
          isValid = false;
        }
      }

      return isValid;
    }

    window.goToNextTab = function () {
      if (!validateCurrentTab()) return;

      let activeIndex = Array.from(tabContents).findIndex((tab) =>
        tab.classList.contains("show", "active")
      );
      if (activeIndex < tabContents.length - 1) {
        tabContents[activeIndex].classList.remove("show", "active");
        tabContents[activeIndex + 1].classList.add("show", "active");
      }
      updateButtons();
    };

    window.goToPreviousTab = function () {
      let activeIndex = Array.from(tabContents).findIndex((tab) =>
        tab.classList.contains("show", "active")
      );
      if (activeIndex > 0) {
        tabContents[activeIndex].classList.remove("show", "active");
        tabContents[activeIndex - 1].classList.add("show", "active");
      }
      updateButtons();
    };

    updateButtons();
  });

  function showSpinner() {
    document.getElementById("spinner-overlay").classList.remove("hidden");
  }

  function hideSpinner() {
    document.getElementById("spinner-overlay").classList.add("hidden");
  }
</script>
<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
  integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
  crossorigin="anonymous"
></script>
{{template "footer" .}}
